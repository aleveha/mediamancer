import sharp from "sharp";

const BLUR_KERNEL_WIDTH = 25;
const BLUR_KERNEL_HEIGHT = 3;

const createHorizontalBlurKernel = () => {
	const blurWeight = 1 / BLUR_KERNEL_WIDTH;
	const topRow = Array(BLUR_KERNEL_WIDTH).fill(0);
	const middleRow = Array(BLUR_KERNEL_WIDTH).fill(blurWeight);
	const bottomRow = Array(BLUR_KERNEL_WIDTH).fill(0);

	return {
		width: BLUR_KERNEL_WIDTH,
		height: BLUR_KERNEL_HEIGHT,
		kernel: [...topRow, ...middleRow, ...bottomRow],
	};
};

const RED_OVERLAY_OPACITY = 0.2;

const createRedOverlay = (width: number, height: number) => {
	return Buffer.from(
		`<svg width="${width}" height="${height}">
			<rect width="${width}" height="${height}" fill="#FF0000" opacity="${RED_OVERLAY_OPACITY}"/>
		</svg>`,
	);
};

const TEXT_SVG_WIDTH = 146;
const TEXT_SVG_HEIGHT = 29;
const TEXT_SVG_PATH =
	"M5.03977 8.58807V5.54545H19.375V8.58807H14.0312V23H10.3835V8.58807H5.03977ZM21.7358 23V5.54545H28.6222C29.9403 5.54545 31.0653 5.78125 31.9972 6.25284C32.9347 6.71875 33.6477 7.38068 34.1364 8.23864C34.6307 9.09091 34.8778 10.0937 34.8778 11.2472C34.8778 12.4062 34.6278 13.4034 34.1278 14.2386C33.6278 15.0682 32.9034 15.7045 31.9545 16.1477C31.0114 16.5909 29.8693 16.8125 28.5284 16.8125H23.9176V13.8466H27.9318C28.6364 13.8466 29.2216 13.75 29.6875 13.5568C30.1534 13.3636 30.5 13.0739 30.7273 12.6875C30.9602 12.3011 31.0767 11.821 31.0767 11.2472C31.0767 10.6676 30.9602 10.179 30.7273 9.78125C30.5 9.38352 30.1506 9.08239 29.679 8.87784C29.2131 8.66761 28.625 8.5625 27.9148 8.5625H25.4261V23H21.7358ZM31.1619 15.0568L35.5 23H31.4261L27.1818 15.0568H31.1619ZM41.1761 5.54545V23H37.4858V5.54545H41.1761ZM55.7862 11.1875C55.6669 10.7727 55.4993 10.4062 55.2834 10.0881C55.0675 9.7642 54.8033 9.49148 54.4908 9.26989C54.1839 9.04261 53.8317 8.86932 53.4339 8.75C53.0419 8.63068 52.6072 8.57102 52.13 8.57102C51.2379 8.57102 50.4538 8.79261 49.7777 9.23579C49.1072 9.67898 48.5845 10.3239 48.2095 11.1705C47.8345 12.0114 47.647 13.0398 47.647 14.2557C47.647 15.4716 47.8317 16.5057 48.201 17.358C48.5703 18.2102 49.093 18.8608 49.7692 19.3097C50.4453 19.7528 51.2436 19.9744 52.1641 19.9744C52.9993 19.9744 53.7124 19.8267 54.3033 19.5312C54.8999 19.2301 55.3544 18.8068 55.6669 18.2614C55.9851 17.7159 56.1442 17.071 56.1442 16.3267L56.8942 16.4375H52.3942V13.6591H59.6982V15.858C59.6982 17.392 59.3743 18.7102 58.7266 19.8125C58.0788 20.9091 57.1868 21.7557 56.0504 22.3523C54.9141 22.9432 53.6129 23.2386 52.147 23.2386C50.5107 23.2386 49.0732 22.8778 47.8345 22.1562C46.5959 21.429 45.63 20.3977 44.9368 19.0625C44.2493 17.7216 43.9055 16.1307 43.9055 14.2898C43.9055 12.875 44.1101 11.6136 44.5192 10.5057C44.9339 9.39205 45.5135 8.44886 46.2578 7.67614C47.0021 6.90341 47.8686 6.31534 48.8572 5.91193C49.8459 5.50852 50.9169 5.30682 52.0703 5.30682C53.0589 5.30682 53.9794 5.4517 54.8317 5.74148C55.6839 6.02557 56.4396 6.42898 57.0987 6.9517C57.7635 7.47443 58.3061 8.09659 58.7266 8.81818C59.147 9.53409 59.4169 10.3239 59.5362 11.1875H55.7862ZM74.044 11.1875C73.9247 10.7727 73.7571 10.4062 73.5412 10.0881C73.3253 9.7642 73.0611 9.49148 72.7486 9.26989C72.4418 9.04261 72.0895 8.86932 71.6918 8.75C71.2997 8.63068 70.8651 8.57102 70.3878 8.57102C69.4957 8.57102 68.7116 8.79261 68.0355 9.23579C67.3651 9.67898 66.8423 10.3239 66.4673 11.1705C66.0923 12.0114 65.9048 13.0398 65.9048 14.2557C65.9048 15.4716 66.0895 16.5057 66.4588 17.358C66.8281 18.2102 67.3509 18.8608 68.027 19.3097C68.7031 19.7528 69.5014 19.9744 70.4219 19.9744C71.2571 19.9744 71.9702 19.8267 72.5611 19.5312C73.1577 19.2301 73.6122 18.8068 73.9247 18.2614C74.2429 17.7159 74.402 17.071 74.402 16.3267L75.152 16.4375H70.652V13.6591H77.956V15.858C77.956 17.392 77.6321 18.7102 76.9844 19.8125C76.3366 20.9091 75.4446 21.7557 74.3082 22.3523C73.1719 22.9432 71.8707 23.2386 70.4048 23.2386C68.7685 23.2386 67.331 22.8778 66.0923 22.1562C64.8537 21.429 63.8878 20.3977 63.1946 19.0625C62.5071 17.7216 62.1634 16.1307 62.1634 14.2898C62.1634 12.875 62.3679 11.6136 62.777 10.5057C63.1918 9.39205 63.7713 8.44886 64.5156 7.67614C65.2599 6.90341 66.1264 6.31534 67.1151 5.91193C68.1037 5.50852 69.1747 5.30682 70.3281 5.30682C71.3168 5.30682 72.2372 5.4517 73.0895 5.74148C73.9418 6.02557 74.6974 6.42898 75.3565 6.9517C76.0213 7.47443 76.5639 8.09659 76.9844 8.81818C77.4048 9.53409 77.6747 10.3239 77.794 11.1875H74.044ZM80.728 23V5.54545H92.4893V8.58807H84.4183V12.7472H91.8842V15.7898H84.4183V19.9574H92.5234V23H80.728ZM95.4233 23V5.54545H102.31C103.628 5.54545 104.753 5.78125 105.685 6.25284C106.622 6.71875 107.335 7.38068 107.824 8.23864C108.318 9.09091 108.565 10.0937 108.565 11.2472C108.565 12.4062 108.315 13.4034 107.815 14.2386C107.315 15.0682 106.591 15.7045 105.642 16.1477C104.699 16.5909 103.557 16.8125 102.216 16.8125H97.6051V13.8466H101.619C102.324 13.8466 102.909 13.75 103.375 13.5568C103.841 13.3636 104.188 13.0739 104.415 12.6875C104.648 12.3011 104.764 11.821 104.764 11.2472C104.764 10.6676 104.648 10.179 104.415 9.78125C104.188 9.38352 103.838 9.08239 103.366 8.87784C102.901 8.66761 102.313 8.5625 101.602 8.5625H99.1136V23H95.4233ZM104.849 15.0568L109.188 23H105.114L100.869 15.0568H104.849ZM111.173 23V5.54545H122.935V8.58807H114.864V12.7472H122.33V15.7898H114.864V19.9574H122.969V23H111.173ZM132.056 23H125.869V5.54545H132.107C133.863 5.54545 135.374 5.89489 136.641 6.59375C137.908 7.28693 138.883 8.28409 139.565 9.58523C140.252 10.8864 140.596 12.4432 140.596 14.2557C140.596 16.0739 140.252 17.6364 139.565 18.9432C138.883 20.25 137.903 21.2528 136.624 21.9517C135.352 22.6506 133.829 23 132.056 23ZM129.559 19.8381H131.903C132.994 19.8381 133.911 19.6449 134.656 19.2585C135.406 18.8665 135.968 18.2614 136.343 17.4432C136.724 16.6193 136.914 15.5568 136.914 14.2557C136.914 12.9659 136.724 11.9119 136.343 11.0938C135.968 10.2756 135.408 9.6733 134.664 9.28693C133.92 8.90057 133.002 8.70739 131.911 8.70739H129.559V19.8381Z";

const createTextBuffer = (imageWidth: number, imageHeight: number) => {
	const { textHeight, textWidth } = calculateTextSize(imageHeight, imageWidth, TEXT_SVG_WIDTH / TEXT_SVG_HEIGHT);

	return Buffer.from(
		`<svg width="${textWidth}" height="${textHeight}" viewBox="0 0 ${TEXT_SVG_WIDTH} ${TEXT_SVG_HEIGHT}">
			<rect width="${textWidth}" height="${textHeight}" fill="#FFB800"/>
			<path d="${TEXT_SVG_PATH}" fill="black"/>
		</svg>`,
	);
};

const TEXT_HEIGHT_MULTIPLIER = 0.2;

const calculateTextSize = (imageHeight: number, imageWidth: number, textAspectRatio: number) => {
	let textHeight = Math.floor(imageHeight * TEXT_HEIGHT_MULTIPLIER);
	let textWidth = Math.floor(textHeight * textAspectRatio);
	if (textWidth > imageWidth) {
		textWidth = imageWidth;
		textHeight = Math.floor(textWidth / textAspectRatio);
	}

	return { textWidth, textHeight };
};

const BRIGHTNESS = 1;
const SATURATION = 2;
const JPEG_QUALITY = 90;

export async function applyTriggeredEffect(imageBuffer: Buffer): Promise<Buffer> {
	const { width: originalImageWidth, height: originalImageHeight } = await sharp(imageBuffer).metadata();
	if (originalImageWidth <= 0 || originalImageHeight <= 0) {
		throw new Error("Invalid image dimensions");
	}

	const horizontalBlurKernel = createHorizontalBlurKernel();
	const redOverlay = createRedOverlay(originalImageWidth, originalImageHeight);
	const textBuffer = createTextBuffer(originalImageWidth, originalImageHeight);

	const withTextAndOverlay = await sharp(imageBuffer)
		.composite([
			{ input: textBuffer, gravity: "south", blend: "over" },
			{ input: redOverlay, blend: "over" },
		])
		.modulate({ brightness: BRIGHTNESS, saturation: SATURATION })
		.toBuffer();

	return sharp(withTextAndOverlay).convolve(horizontalBlurKernel).jpeg({ quality: JPEG_QUALITY }).toBuffer();
}
